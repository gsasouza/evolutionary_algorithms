!function(e){var t={};function r(n){if(t[n])return t[n].exports;var a=t[n]={i:n,l:!1,exports:{}};return e[n].call(a.exports,a,a.exports,r),a.l=!0,a.exports}r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)r.d(n,a,function(t){return e[t]}.bind(null,a));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=12)}([function(e,t){e.exports=require("graphql")},function(e,t){e.exports=require("cluster")},function(e,t){e.exports=require("os")},function(e,t){e.exports=require("redis")},function(e,t){e.exports=require("graphql-subscriptions")},function(e,t){e.exports=require("http")},function(e,t){e.exports=require("koa")},function(e,t){e.exports=require("kcors")},function(e,t){e.exports=require("koa-router")},function(e,t){e.exports=require("koa-graphql")},function(e,t){e.exports=require("graphql-playground-middleware-koa")},function(e,t){e.exports=require("subscriptions-transport-ws")},function(e,t,r){e.exports=r(13)},function(e,t,r){"use strict";r.r(t);var n=r(1),a=r.n(n),o=r(2),s=r.n(o);function l(e,t){e*=Math.pow(4,t);const r=Math.abs(e),n=Math.floor(r);return Math.pow(.75,t)*Math.abs(r-n-n%2)}const u=(e=p[0],t=p[1])=>Math.random()*(t-e+1)+e,i=e=>function(e,t){let r=0;for(let n=0;n<=t;n++)r+=l(e,n);return r}(e,100),p=[0,1],c=(e,t)=>{const r=JSON.parse(e||"{}"),n=JSON.parse(t||"{} ");return Number.parseFloat(r.result)>Number.parseFloat(n.result)?r:n},T=(e,t,r)=>((e,t)=>{const r=c(e[Math.round(u(0,98))],e[Math.round(u(0,98))]),n=c(e[Math.round(u(0,98))],e[Math.round(u(0,98))]);return(Number.parseFloat(r.value)+Number.parseFloat(n.value)+Number.parseFloat(t.value))/3})(r,t);var I=r(3);const S=r.n(I).a.createClient();S.on("error",(function(e){console.error(e)}));const L=e=>new Promise((t,r)=>{S.lrange(e,0,-1,(function(e,n){e&&r(e),t(n)}))}),E=(e,t,r)=>{if("object"==typeof t){const n=JSON.stringify(t);return S.rpush([e,n],r)}return S.rpush([e,t],r)},d=(e,t)=>S.llen(e,t),N=e=>new Promise((t,r)=>{S.get(e,(e,n)=>{e&&r(e),t(n)})});var f=S;const b=e=>{const t=e%global.workers.length;return global.workers[t]},A="CREATE",h="TEST",D="SELECTION",_="ANALYZE",g=()=>{const e=u();return E("POPULATION_LIST",e,()=>process.send({type:V.CREATED_INDIVIDUALS}))},y=()=>{d("POPULATION_LIST",(e,t)=>{if(global.step===A)return 100===t?(global.step=h,v()):void 0})},v=async()=>{(await L("POPULATION_LIST")).forEach((e,t)=>{b(t).send({type:x.TEST_INDIVIDUAL,payload:{individual:e}})})},O=async()=>{const e=await L("TESTED_LIST"),t=await R(e);await(async e=>{const{shouldIncreaseRate:t,increaseRate:r,decreaseRate:n,shouldReturnToBaseRate:a,returnToBaseRate:o,shouldDecrease:s,LAST_COUNT:l,FITNESS_THRESHOLD:u}=global.mutationConfig;if(t())return r();if(a())return o();if(!s())return;const i=await L("PAST_LIST");if(i<l)return;const p=i.slice(Math.max(i.length-l,0)),c=p.reduce((e,t)=>e+Number.parseFloat(t),0)/p.length;return Math.abs(c-e.result)<u?n():void 0})(t),(e=>{f.set("BEST_RESULT",JSON.stringify(e)),f.del("POPULATION_LIST"),E("POPULATION_LIST",Number.parseFloat(e.value))})(t),e.filter((e,r)=>r!==t.index).forEach((r,n)=>{b(n).send({type:x.SELECT_INDIVIDUAL,payload:{individual:JSON.parse(r),mutationRate:global.mutationConfig.getRate(),resultList:e,bestResult:t}})})},R=async e=>e.reduce((e,t,r)=>{const{result:n,value:a}=JSON.parse(t);return n>e.result?{value:a,result:n,index:r}:e},{result:0});var P=r(4);const U={NEW:"NEW_RESULT"};var m=new P.PubSub;const w=async({payload:e})=>{const{mutationRate:t,resultList:r,individual:n,bestResult:a}=e,o=((e,t)=>{const r=.5*p[1],n=e+(u(p[0],r)-u(p[0],r))*t;return n>p[1]?n-p[1]:n<p[0]?n+p[1]:n})(T(0,a,r),t);E("POPULATION_LIST",o,()=>process.send({type:V.SELECTED_INDIVIDUALS}))},M=()=>(global.step=A,f.del("TESTED_LIST"),y()),C=async()=>{global.mutationConfig.increaseGenerationWithRate();const e=await N("GENERATIONS")||1,t=await N("BEST_RESULT"),{result:r,value:n}=JSON.parse(t);if(E("PAST_LIST",r),f.set("GENERATIONS",`${Number.parseInt(e)+1}`),process.env.TERMINAL)return console.log(`${Number.parseInt(e)}# FITNESS: ${r}, MUTATION RATE: ${global.mutationConfig.getRate()}`);const a=await L("TESTED_LIST"),o=await L("POPULATION_LIST"),s=a.reduce((e,t)=>{const r=JSON.parse(t);return e+Number.parseFloat(r.result)},0)/a.length;return E("PAST_POPULATION_MEAN_LIST",s),(async({generation:e,fitness:t,value:r,population:n,populationResultMean:a})=>{await m.publish(U.NEW,{NewResult:{fitness:t,generation:e,value:r,population:n,populationResultMean:a}})})({generation:Number.parseInt(e),fitness:r,value:Number.parseFloat(n),population:o.map(e=>Number.parseFloat(e)),results:a,populationResultMean:s})},G=async()=>{if(await C(),process.env.TERMINAL)return M();setTimeout(M,50)},x={CREATE_POPULATION_INDIVIDUAL:"CREATE_POPULATION_INDIVIDUAL",TEST_INDIVIDUAL:"TEST_INDIVIDUAL",SELECT_INDIVIDUAL:"SELECT_INDIVIDUAL"},V={START:"START",CREATED_INDIVIDUALS:"CREATED_INDIVIDUALS",TESTED_INDIVIDUALS:"TESTED_INDIVIDUALS",SELECTED_INDIVIDUALS:"SELECTED_INDIVIDUALS"};var F=({type:e})=>{switch(e){case V.START:return new Array(100).fill(null).forEach((e,t)=>{b(t).send({type:x.CREATE_POPULATION_INDIVIDUAL})});case V.CREATED_INDIVIDUALS:return y();case V.TESTED_INDIVIDUALS:return void d("TESTED_LIST",async(e,t)=>{if(global.step===h)return 100===t?(global.step=D,O()):void 0});case V.SELECTED_INDIVIDUALS:return void d("POPULATION_LIST",(e,t)=>{if(global.step===D)return 100===t?(global.step=_,G()):void 0});default:return}},Q=r(5),q=r(6),k=r.n(q),j=r(7),J=r.n(j),W=r(8),B=r.n(W),H=r(9),$=r.n(H),Y=r(10),Z=r.n(Y),z=r(11),K=r(0);var X={type:new K.GraphQLObjectType({name:"NewResultPayload",fields:()=>({fitness:{type:K.GraphQLFloat,resolve:({fitness:e})=>e},value:{type:K.GraphQLFloat,resolve:({value:e})=>e},generation:{type:K.GraphQLInt,resolve:({generation:e})=>e},population:{type:new K.GraphQLList(K.GraphQLFloat),resolve:({population:e})=>e},populationResultMean:{type:K.GraphQLFloat,resolve:({populationResultMean:e})=>e}})}),subscribe:()=>m.asyncIterator(U.NEW)},ee=new K.GraphQLObjectType({name:"Subscription",fields:{NewResult:X}});const te=new K.GraphQLObjectType({name:"Result",description:"Result data",fields:()=>({fitness:{type:K.GraphQLFloat,resolve:({fitness:e})=>e},value:{type:K.GraphQLFloat,resolve:({value:e})=>e},generation:{type:K.GraphQLInt,resolve:({generation:e})=>e},population:{type:new K.GraphQLList(K.GraphQLFloat),resolve:({population:e})=>e},pastResults:{type:new K.GraphQLList(K.GraphQLFloat),resolve:async()=>L("PAST_LIST")},populationResultsMean:{type:Object(K.GraphQLList)(K.GraphQLFloat),resolve:async()=>L("PAST_POPULATION_MEAN_LIST")}})}),re=new K.GraphQLObjectType({name:"Query",description:"The root of all... queries",fields:()=>({status:{type:K.GraphQLString,resolve:()=>"online"},results:{type:te,resolve:()=>({fitness:0,generation:0})}})});var ne=new K.GraphQLSchema({query:re,subscription:ee});global.workers=[],global.step=A,global.mutationConfig=(()=>{let e=.1,t=0,r=0,n=null,a=0,o=0;return{decreaseRate:()=>{r=50,t=0,n="decrease",o+=1;const a=Math.pow(10,o/2>=4?4:o);e=.1/a},increaseRate:()=>{r=25,t=0,n="increase",a+=1,e=.1*(2*a>10?10:2*a)},returnToBaseRate:()=>{r=0,t=0,n=null,e=.1},increaseGenerationWithRate:()=>{t+=1},getRate:()=>e,getGenerationWithRate:()=>t,shouldIncreaseRate:()=>!!r&&t>=r&&"decrease"===n,shouldReturnToBaseRate:()=>r&&t>=r&&"increase"===n,shouldDecrease:()=>!r,LAST_COUNT:50,FITNESS_THRESHOLD:1e-13}})();const ae=s.a.cpus().length;var oe=()=>{f.del("POPULATION_LIST"),f.del("TESTED_LIST"),f.del("PAST_LIST"),f.del("GENERATIONS"),f.del("BEST_RESULT"),f.del("PAST_POPULATION_MEAN_LIST");for(let e=0;e<ae;e++){const e=a.a.fork();global.workers.push(e),e.on("message",e=>F(e))}(()=>{const e=new k.a,t=new B.a;t.all("/playground",Z()({endpoint:"/graphql",subscriptionEndpoint:"ws://localhost:5000/subscriptions"})),t.all("/graphql",$()({schema:ne,graphiql:!1})),e.use(J()()),e.use(t.routes()).use(t.allowedMethods());const r=Object(Q.createServer)(e.callback());r.listen(5e3,()=>{console.log("Server started on port 5000"),z.SubscriptionServer.create({onConnect:e=>console.log("Client subscription connected!",e),onDisconnect:()=>console.log("Client subscription disconnected!"),execute:K.execute,subscribe:K.subscribe,schema:ne},{server:r,path:"/subscriptions"})})})(),F({type:V.START})};var se=e=>{const{type:t}=e;switch(t){case x.CREATE_POPULATION_INDIVIDUAL:return g();case x.TEST_INDIVIDUAL:return(({payload:e})=>{const{individual:t}=e,r=i(Number.parseFloat(t));return E("TESTED_LIST",{value:t,result:r},()=>{process.send({type:V.TESTED_INDIVIDUALS})})})(e);case x.SELECT_INDIVIDUAL:return w(e);default:return}};var le=()=>{a.a.worker.on("message",e=>se(e))};a.a.isMaster?oe():le(),a.a.on("exit",e=>{console.log("mayday! mayday! worker",e.id," is no more!"),a.a.fork()}),a.a.on("online",(function(e){console.log("Worker "+e.process.pid+" is listening")}))}]);