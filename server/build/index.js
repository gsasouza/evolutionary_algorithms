!function(e){var t={};function r(n){if(t[n])return t[n].exports;var a=t[n]={i:n,l:!1,exports:{}};return e[n].call(a.exports,a,a.exports,r),a.l=!0,a.exports}r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)r.d(n,a,function(t){return e[t]}.bind(null,a));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=12)}([function(e,t){e.exports=require("graphql")},function(e,t){e.exports=require("cluster")},function(e,t){e.exports=require("os")},function(e,t){e.exports=require("redis")},function(e,t){e.exports=require("graphql-subscriptions")},function(e,t){e.exports=require("http")},function(e,t){e.exports=require("koa")},function(e,t){e.exports=require("kcors")},function(e,t){e.exports=require("koa-router")},function(e,t){e.exports=require("koa-graphql")},function(e,t){e.exports=require("graphql-playground-middleware-koa")},function(e,t){e.exports=require("subscriptions-transport-ws")},function(e,t,r){e.exports=r(13)},function(e,t,r){"use strict";r.r(t);var n=r(1),a=r.n(n),o=r(2),s=r.n(o),l=r(3);const i=r.n(l).a.createClient();i.on("error",(function(e){console.error(e)}));const u=e=>new Promise((t,r)=>{i.lrange(e,0,-1,(function(e,n){e&&r(e),t(n)}))}),p=(e,t,r)=>{if("object"==typeof t){const n=JSON.stringify(t);return i.rpush([e,n],r)}return i.rpush([e,t],r)},c=(e,t)=>i.llen(e,t),T=e=>new Promise((t,r)=>{i.get(e,(e,n)=>{e&&r(e),t(n)})});var I=i;const L=e=>{const t=e%global.workers.length;return global.workers[t]},S="CREATE",E="TEST",d="SELECTION",f="ANALYZE",N=(e=A[0],t=A[1])=>Math.random()*(t-e+1)+e,A=[0,100],b=(e,t,r)=>((e,t)=>(Number.parseFloat(e.value)+Number.parseFloat(t.value))/2)(e,t),D=()=>{const e=N();return p("POPULATION_LIST",e,()=>process.send({type:G.CREATED_INDIVIDUALS}))},h=()=>{c("POPULATION_LIST",(e,t)=>{if(global.step===S)return 5===t?(global.step=E,g()):void 0})},_=({payload:e})=>{const{individual:t}=e,r=(n=Number.parseFloat(t),2*Math.cos(.39*n)+5*Math.sin(.5*n)+.5*Math.cos(.1*n)+10*Math.sin(.7*n)+5*Math.sin(1*n)+5*Math.sin(.35*n));var n;return p("TESTED_LIST",{value:t,result:r},()=>{process.send({type:G.TESTED_INDIVIDUALS})})},g=async()=>{(await u("POPULATION_LIST")).forEach((e,t)=>{L(t).send({type:M.TEST_INDIVIDUAL,payload:{individual:e}})})},y=async()=>{const e=await u("TESTED_LIST"),t=await v(e);await(async e=>{const{shouldIncreaseRate:t,increaseRate:r,decreaseRate:n,shouldReturnToBaseRate:a,returnToBaseRate:o,shouldDecrease:s,LAST_COUNT:l,FITNESS_THRESHOLD:i}=global.mutationConfig;if(t())return r();if(a())return o();if(!s())return;const p=await u("PAST_LIST");if(p<l)return;const c=p.slice(Math.max(p.length-l,0)),T=c.reduce((e,t)=>e+Number.parseFloat(t),0)/c.length;return Math.abs(T-e.result)<i?n():void 0})(t),(e=>{I.set("BEST_RESULT",JSON.stringify(e)),I.del("POPULATION_LIST"),p("POPULATION_LIST",Number.parseFloat(e.value))})(t),e.filter((e,r)=>r!==t.index).forEach((r,n)=>{L(n).send({type:M.SELECT_INDIVIDUAL,payload:{individual:JSON.parse(r),mutationRate:global.mutationConfig.getRate(),resultList:e,bestResult:t}})})},v=async e=>e.reduce((e,t,r)=>{const{result:n,value:a}=JSON.parse(t);return n>e.result?{value:a,result:n,index:r}:e},{result:0});var O=r(4);const R={NEW:"NEW_RESULT"};var P=new O.PubSub;const U=async({payload:e})=>{const{mutationRate:t,resultList:r,individual:n,bestResult:a}=e,o=((e,t)=>{const r=.5*A[1],n=e+(N(A[0],r)-N(A[0],r))*t;return n>A[1]?n-A[1]:n<A[0]?n+A[1]:n})(b(n,a),t);p("POPULATION_LIST",o,()=>process.send({type:G.SELECTED_INDIVIDUALS}))},m=()=>(global.step=S,I.del("TESTED_LIST"),h()),w=async()=>{global.mutationConfig.increaseGenerationWithRate();const e=await T("GENERATIONS")||1,t=await T("BEST_RESULT"),{result:r,value:n}=JSON.parse(t);if(p("PAST_LIST",r),I.set("GENERATIONS",`${Number.parseInt(e)+1}`),process.env.TERMINAL)return console.log(`${Number.parseInt(e)}# FITNESS: ${r}, MUTATION RATE: ${global.mutationConfig.getRate()}`);const a=await u("TESTED_LIST"),o=await u("POPULATION_LIST"),s=a.reduce((e,t)=>{const r=JSON.parse(t);return e+Number.parseFloat(r.result)},0)/a.length;return p("PAST_POPULATION_MEAN_LIST",s),(async({generation:e,fitness:t,value:r,population:n,populationResultMean:a})=>{await P.publish(R.NEW,{NewResult:{fitness:t,generation:e,value:r,population:n,populationResultMean:a}})})({generation:Number.parseInt(e),fitness:r,value:Number.parseFloat(n),population:o.map(e=>Number.parseFloat(e)),results:a,populationResultMean:s})},C=async()=>{if(await w(),process.env.TERMINAL)return m();setTimeout(m,100)},M={CREATE_POPULATION_INDIVIDUAL:"CREATE_POPULATION_INDIVIDUAL",TEST_INDIVIDUAL:"TEST_INDIVIDUAL",SELECT_INDIVIDUAL:"SELECT_INDIVIDUAL"},G={START:"START",CREATED_INDIVIDUALS:"CREATED_INDIVIDUALS",TESTED_INDIVIDUALS:"TESTED_INDIVIDUALS",SELECTED_INDIVIDUALS:"SELECTED_INDIVIDUALS"};var x=({type:e})=>{switch(e){case G.START:return new Array(5).fill(null).forEach((e,t)=>{L(t).send({type:M.CREATE_POPULATION_INDIVIDUAL})});case G.CREATED_INDIVIDUALS:return h();case G.TESTED_INDIVIDUALS:return void c("TESTED_LIST",async(e,t)=>{if(global.step===E)return 5===t?(global.step=d,y()):void 0});case G.SELECTED_INDIVIDUALS:return void c("POPULATION_LIST",(e,t)=>{if(global.step===d)return 5===t?(global.step=f,C()):void 0});default:return}},V=r(5),Q=r(6),q=r.n(Q),F=r(7),k=r.n(F),j=r(8),W=r.n(j),B=r(9),J=r.n(B),H=r(10),$=r.n(H),Y=r(11),Z=r(0);var z={type:new Z.GraphQLObjectType({name:"NewResultPayload",fields:()=>({fitness:{type:Z.GraphQLFloat,resolve:({fitness:e})=>e},value:{type:Z.GraphQLFloat,resolve:({value:e})=>e},generation:{type:Z.GraphQLInt,resolve:({generation:e})=>e},population:{type:new Z.GraphQLList(Z.GraphQLFloat),resolve:({population:e})=>e},populationResultMean:{type:Z.GraphQLFloat,resolve:({populationResultMean:e})=>e}})}),subscribe:()=>P.asyncIterator(R.NEW)},K=new Z.GraphQLObjectType({name:"Subscription",fields:{NewResult:z}});const X=new Z.GraphQLObjectType({name:"Result",description:"Result data",fields:()=>({fitness:{type:Z.GraphQLFloat,resolve:({fitness:e})=>e},value:{type:Z.GraphQLFloat,resolve:({value:e})=>e},generation:{type:Z.GraphQLInt,resolve:({generation:e})=>e},population:{type:new Z.GraphQLList(Z.GraphQLFloat),resolve:({population:e})=>e},pastResults:{type:new Z.GraphQLList(Z.GraphQLFloat),resolve:async()=>u("PAST_LIST")},populationResultsMean:{type:Object(Z.GraphQLList)(Z.GraphQLFloat),resolve:async()=>u("PAST_POPULATION_MEAN_LIST")}})}),ee=new Z.GraphQLObjectType({name:"Query",description:"The root of all... queries",fields:()=>({status:{type:Z.GraphQLString,resolve:()=>"online"},results:{type:X,resolve:()=>({fitness:0,generation:0})}})});var te=new Z.GraphQLSchema({query:ee,subscription:K});global.workers=[],global.step=S,global.mutationConfig=(()=>{let e=.1,t=0,r=0,n=null,a=0,o=0;return{decreaseRate:()=>{r=50,t=0,n="decrease",o+=1;const a=Math.pow(10,o/2>=4?4:o);e=.1/a},increaseRate:()=>{r=25,t=0,n="increase",a+=1,e=.1*(2*a>10?10:2*a)},returnToBaseRate:()=>{r=0,t=0,n=null,e=.1},increaseGenerationWithRate:()=>{t+=1},getRate:()=>e,getGenerationWithRate:()=>t,shouldIncreaseRate:()=>!!r&&t>=r&&"decrease"===n,shouldReturnToBaseRate:()=>r&&t>=r&&"increase"===n,shouldDecrease:()=>!r,LAST_COUNT:50,FITNESS_THRESHOLD:1e-13}})();const re=s.a.cpus().length;var ne=()=>{I.del("POPULATION_LIST"),I.del("TESTED_LIST"),I.del("PAST_LIST"),I.del("GENERATIONS"),I.del("BEST_RESULT"),I.del("PAST_POPULATION_MEAN_LIST");for(let e=0;e<re;e++){const e=a.a.fork();global.workers.push(e),e.on("message",e=>x(e))}(()=>{const e=new q.a,t=new W.a;t.all("/playground",$()({endpoint:"/graphql",subscriptionEndpoint:"ws://localhost:5000/subscriptions"})),t.all("/graphql",J()({schema:te,graphiql:!1})),e.use(k()()),e.use(t.routes()).use(t.allowedMethods());const r=Object(V.createServer)(e.callback());r.listen(5e3,()=>{console.log("Server started on port 5000"),Y.SubscriptionServer.create({onConnect:e=>console.log("Client subscription connected!",e),onDisconnect:()=>console.log("Client subscription disconnected!"),execute:Z.execute,subscribe:Z.subscribe,schema:te},{server:r,path:"/subscriptions"})})})(),x({type:G.START})};var ae=e=>{const{type:t}=e;switch(t){case M.CREATE_POPULATION_INDIVIDUAL:return D();case M.TEST_INDIVIDUAL:return _(e);case M.SELECT_INDIVIDUAL:return U(e);default:return}};var oe=()=>{a.a.worker.on("message",e=>ae(e))};a.a.isMaster?ne():oe(),a.a.on("exit",e=>{console.log("mayday! mayday! worker",e.id," is no more!"),a.a.fork()}),a.a.on("online",(function(e){console.log("Worker "+e.process.pid+" is listening")}))}]);